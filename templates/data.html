{% extends "base.html" %}

{% block title %}Data Management - Student Result Predictor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h2 class="mb-0">
                    <i class="fas fa-database me-2"></i>Data Management
                </h2>
            </div>
            <div class="card-body p-4">
                <!-- Statistics Overview -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h4 class="text-info mb-3">
                            <i class="fas fa-chart-bar me-2"></i>Data Statistics
                        </h4>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0">{{ stats.total_records or 0 }}</h3>
                                <p class="mb-0">Total Records</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0">{{ stats.pass_count or 0 }}</h3>
                                <p class="mb-0">Pass Predictions</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0">{{ stats.fail_count or 0 }}</h3>
                                <p class="mb-0">Fail Predictions</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0">{{ "%.1f"|format(stats.pass_rate or 0) }}%</h3>
                                <p class="mb-0">Pass Rate</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Export Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-download me-2"></i>Export Data
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="export-format" class="form-label">Export Format</label>
                                        <select class="form-select" id="export-format">
                                            <option value="excel">Excel (.xlsx)</option>
                                            <option value="csv">CSV (.csv)</option>
                                            <option value="json">JSON (.json)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="export-filename" class="form-label">Filename (Optional)</label>
                                        <input type="text" class="form-control" id="export-filename" 
                                               placeholder="student_data_export">
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-success" onclick="exportData()">
                                    <i class="fas fa-download me-2"></i>Export Data
                                </button>
                                
                                <div id="export-status" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Management Actions -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-warning text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-tools me-2"></i>Data Management
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <button type="button" class="btn btn-outline-primary w-100" onclick="refreshData()">
                                            <i class="fas fa-sync-alt me-2"></i>Refresh Data
                                        </button>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <button type="button" class="btn btn-outline-info w-100" onclick="viewDataPreview()">
                                            <i class="fas fa-eye me-2"></i>View Data Preview
                                        </button>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="downloadSample()">
                                            <i class="fas fa-file-download me-2"></i>Download Sample
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Preview Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>Recent Data Preview
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="data-preview-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Student ID</th>
                                                <th>Name</th>
                                                <th>Gender</th>
                                                <th>Attendance %</th>
                                                <th>Final Exam</th>
                                                <th>Predicted Result</th>
                                                <th>Confidence</th>
                                                <th>Model Used</th>
                                            </tr>
                                        </thead>
                                        <tbody id="data-preview-body">
                                            <tr>
                                                <td colspan="8" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading data...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Preview Modal -->
<div class="modal fade" id="dataPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-table me-2"></i>Complete Data Preview
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="full-data-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Gender</th>
                                <th>Age</th>
                                <th>Attendance %</th>
                                <th>Assignment</th>
                                <th>Midterm</th>
                                <th>Final Exam</th>
                                <th>Study Hours</th>
                                <th>GPA</th>
                                <th>Activities</th>
                                <th>Income</th>
                                <th>Parent Education</th>
                                <th>Predicted Result</th>
                                <th>Predicted Grade</th>
                                <th>Confidence</th>
                                <th>Model Used</th>
                            </tr>
                        </thead>
                        <tbody id="full-data-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="exportData()">
                    <i class="fas fa-download me-2"></i>Export This Data
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Export data function
function exportData() {
    const format = document.getElementById('export-format').value;
    const filename = document.getElementById('export-filename').value;
    const statusDiv = document.getElementById('export-status');
    
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Exporting data...</div>';
    
    fetch('/api/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            format: format,
            filename: filename || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check me-2"></i>' + data.message + '</div>';
            
            // Trigger download if file path is provided
            if (data.file_path) {
                const link = document.createElement('a');
                link.href = data.file_path;
                link.download = data.filename || 'student_data_export';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        } else {
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>' + data.message + '</div>';
        }
    })
    .catch(error => {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Export failed: ' + error.message + '</div>';
    });
}

// Refresh data function
function refreshData() {
    location.reload();
}

// View data preview function
function viewDataPreview() {
    const modal = new bootstrap.Modal(document.getElementById('dataPreviewModal'));
    modal.show();
    loadFullData();
}

// Download sample function
function downloadSample() {
    const link = document.createElement('a');
    link.href = '/static/sample_student_data.csv';
    link.download = 'sample_student_data.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Load full data for modal
function loadFullData() {
    const tbody = document.getElementById('full-data-body');
    tbody.innerHTML = '<tr><td colspan="17" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</td></tr>';
    
    fetch('/api/stats')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.stats.recent_data) {
            displayFullData(data.stats.recent_data);
        } else {
            tbody.innerHTML = '<tr><td colspan="17" class="text-center text-muted">No data available</td></tr>';
        }
    })
    .catch(error => {
        tbody.innerHTML = '<tr><td colspan="17" class="text-center text-danger">Error loading data</td></tr>';
    });
}

// Display full data in modal
function displayFullData(data) {
    const tbody = document.getElementById('full-data-body');
    tbody.innerHTML = '';
    
    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.student_id || 'N/A'}</td>
            <td>${row.name || 'N/A'}</td>
            <td>${row.gender || 'N/A'}</td>
            <td>${row.age || 'N/A'}</td>
            <td>${row.attendance_percentage || 'N/A'}%</td>
            <td>${row.assignment_marks || 'N/A'}</td>
            <td>${row.midterm_marks || 'N/A'}</td>
            <td>${row.final_exam_marks || 'N/A'}</td>
            <td>${row.study_hours_per_day || 'N/A'}</td>
            <td>${row.previous_semester_gpa || 'N/A'}</td>
            <td>${row.extracurricular_activities || 'N/A'}</td>
            <td>${row.family_income || 'N/A'}</td>
            <td>${row.parent_education || 'N/A'}</td>
            <td><span class="badge ${row.predicted_result === 1 ? 'bg-success' : 'bg-danger'}">${row.predicted_result === 1 ? 'Pass' : 'Fail'}</span></td>
            <td>${row.predicted_grade || 'N/A'}</td>
            <td>${row.confidence_score ? (row.confidence_score * 100).toFixed(1) + '%' : 'N/A'}</td>
            <td>${row.model_used || 'N/A'}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Load preview data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPreviewData();
});

// Load preview data
function loadPreviewData() {
    const tbody = document.getElementById('data-preview-body');
    
    fetch('/api/stats')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.stats.recent_data) {
            displayPreviewData(data.stats.recent_data.slice(0, 10)); // Show first 10 records
        } else {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No data available</td></tr>';
        }
    })
    .catch(error => {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
    });
}

// Display preview data
function displayPreviewData(data) {
    const tbody = document.getElementById('data-preview-body');
    tbody.innerHTML = '';
    
    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.student_id || 'N/A'}</td>
            <td>${row.name || 'N/A'}</td>
            <td>${row.gender || 'N/A'}</td>
            <td>${row.attendance_percentage || 'N/A'}%</td>
            <td>${row.final_exam_marks || 'N/A'}</td>
            <td><span class="badge ${row.predicted_result === 1 ? 'bg-success' : 'bg-danger'}">${row.predicted_result === 1 ? 'Pass' : 'Fail'}</span></td>
            <td>${row.confidence_score ? (row.confidence_score * 100).toFixed(1) + '%' : 'N/A'}</td>
            <td>${row.model_used || 'N/A'}</td>
        `;
        tbody.appendChild(tr);
    });
}
</script>
{% endblock %} 