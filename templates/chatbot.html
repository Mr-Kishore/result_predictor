{% extends "base.html" %}

{% block title %}AI Assistant - Student Result Predictor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h2 class="mb-0">
                    <i class="fas fa-robot me-2"></i>AI Assistant
                </h2>
            </div>
            <div class="card-body p-0">
                <!-- Chat Messages -->
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot">
                        <div class="d-flex align-items-start">
                            <div class="bot-avatar me-2">
                                <i class="fas fa-robot text-info"></i>
                            </div>
                            <div class="message-content">
                                <strong>Student Result Predictor Bot</strong>
                                <p class="mb-0">Hello! I'm your AI assistant for the Student Result Predictor system. I can help you understand how predictions work, explain features, provide study advice, and answer any questions about the system. How can I assist you today?</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input">
                    <form id="chat-form">
                        <div class="input-group">
                            <textarea class="form-control" id="chat-input" placeholder="Type your message here..." rows="1"></textarea>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Quick Questions -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Quick Questions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2" id="quick-questions">
                    <button class="btn btn-outline-primary btn-sm text-start" onclick="askQuestion('How does the prediction system work?')">
                        <i class="fas fa-question-circle me-2"></i>How does the prediction system work?
                    </button>
                    <button class="btn btn-outline-primary btn-sm text-start" onclick="askQuestion('What factors are considered in predictions?')">
                        <i class="fas fa-list me-2"></i>What factors are considered?
                    </button>
                    <button class="btn btn-outline-primary btn-sm text-start" onclick="askQuestion('How accurate are the predictions?')">
                        <i class="fas fa-chart-line me-2"></i>How accurate are predictions?
                    </button>
                    <button class="btn btn-outline-primary btn-sm text-start" onclick="askQuestion('How can I improve my performance?')">
                        <i class="fas fa-arrow-up me-2"></i>How to improve performance?
                    </button>
                    <button class="btn btn-outline-primary btn-sm text-start" onclick="askQuestion('What machine learning models are used?')">
                        <i class="fas fa-brain me-2"></i>What ML models are used?
                    </button>
                    <button class="btn btn-outline-primary btn-sm text-start" onclick="askQuestion('How are grades calculated?')">
                        <i class="fas fa-calculator me-2"></i>How are grades calculated?
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Chatbot Info -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>About the Assistant
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6><i class="fas fa-robot me-2"></i>Capabilities</h6>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success me-2"></i>Explain prediction methodology</li>
                        <li><i class="fas fa-check text-success me-2"></i>Provide study advice</li>
                        <li><i class="fas fa-check text-success me-2"></i>Answer system questions</li>
                        <li><i class="fas fa-check text-success me-2"></i>Help with data upload</li>
                        <li><i class="fas fa-check text-success me-2"></i>Explain model features</li>
                    </ul>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-cog me-2"></i>How to Use</h6>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-arrow-right text-primary me-2"></i>Type your question</li>
                        <li><i class="fas fa-arrow-right text-primary me-2"></i>Click quick questions</li>
                        <li><i class="fas fa-arrow-right text-primary me-2"></i>Get instant answers</li>
                        <li><i class="fas fa-arrow-right text-primary me-2"></i>Follow suggestions</li>
                    </ul>
                </div>
                
                <div class="alert alert-info small">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> Ask specific questions for better answers. The assistant learns from your interactions!
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('main.predict') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-calculator me-2"></i>Make Prediction
                    </a>
                    <a href="{{ url_for('main.upload') }}" class="btn btn-success btn-sm">
                        <i class="fas fa-upload me-2"></i>Upload Data
                    </a>
                    <a href="{{ url_for('main.models') }}" class="btn btn-info btn-sm">
                        <i class="fas fa-brain me-2"></i>View Models
                    </a>
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-home me-2"></i>Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Suggestions Container -->
<div class="row mt-4" id="suggestions-container" style="display: none;">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Suggested Questions
                </h5>
            </div>
            <div class="card-body">
                <div id="suggestions-list" class="d-flex flex-wrap gap-2">
                    <!-- Suggestions will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    
    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
    
    // Send message on Enter (but allow Shift+Enter for new line)
    chatInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            handleChatSubmit(event);
        }
    });
    
    // Form submission
    chatForm.addEventListener('submit', handleChatSubmit);
    
    // Focus on input
    chatInput.focus();
});

function handleChatSubmit(event) {
    event.preventDefault();
    
    const chatInput = document.getElementById('chat-input');
    const message = chatInput.value.trim();
    
    if (!message) return;
    
    // Add user message
    addChatMessage(message, 'user');
    chatInput.value = '';
    chatInput.style.height = 'auto';
    
    // Show typing indicator
    const typingIndicator = addTypingIndicator();
    
    // Send to server
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        // Remove typing indicator
        typingIndicator.remove();
        
        if (data.success) {
            addChatMessage(data.response, 'bot');
            
            // Add suggestions if available
            if (data.suggestions && data.suggestions.length > 0) {
                addSuggestions(data.suggestions);
            }
        } else {
            addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
        }
    })
    .catch(error => {
        typingIndicator.remove();
        addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
        console.error('Chat error:', error);
    });
}

function addChatMessage(message, sender) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender} fade-in`;
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start justify-content-end">
                <div class="message-content text-end">
                    <p class="mb-0">${escapeHtml(message)}</p>
                </div>
                <div class="user-avatar ms-2">
                    <i class="fas fa-user text-primary"></i>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="bot-avatar me-2">
                    <i class="fas fa-robot text-info"></i>
                </div>
                <div class="message-content">
                    <strong>Student Result Predictor Bot</strong>
                    <p class="mb-0">${escapeHtml(message)}</p>
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addTypingIndicator() {
    const chatMessages = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot typing-indicator';
    typingDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="bot-avatar me-2">
                <i class="fas fa-robot text-info"></i>
            </div>
            <div class="message-content">
                <strong>Student Result Predictor Bot</strong>
                <p class="mb-0">
                    <i class="fas fa-ellipsis-h"></i> Typing...
                </p>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return typingDiv;
}

function addSuggestions(suggestions) {
    const suggestionsContainer = document.getElementById('suggestions-container');
    const suggestionsList = document.getElementById('suggestions-list');
    
    suggestionsList.innerHTML = '';
    
    suggestions.forEach(suggestion => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary btn-sm';
        btn.textContent = suggestion;
        btn.onclick = () => askQuestion(suggestion);
        suggestionsList.appendChild(btn);
    });
    
    suggestionsContainer.style.display = 'block';
}

function askQuestion(question) {
    const chatInput = document.getElementById('chat-input');
    chatInput.value = question;
    chatInput.focus();
    handleChatSubmit(new Event('submit'));
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Add some predefined questions for quick access
const predefinedQuestions = [
    'How does the prediction system work?',
    'What factors are considered in predictions?',
    'How accurate are the predictions?',
    'How can I improve my performance?',
    'What machine learning models are used?',
    'How are grades calculated?',
    'How important is attendance?',
    'How many study hours are recommended?',
    'How does previous GPA affect predictions?',
    'How can I download my results?'
];

// Populate quick questions dynamically
document.addEventListener('DOMContentLoaded', function() {
    const quickQuestionsContainer = document.getElementById('quick-questions');
    
    predefinedQuestions.forEach(question => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary btn-sm text-start';
        btn.innerHTML = `<i class="fas fa-question-circle me-2"></i>${question}`;
        btn.onclick = () => askQuestion(question);
        quickQuestionsContainer.appendChild(btn);
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.chat-messages {
    height: 500px;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
}

.message {
    margin-bottom: 1rem;
    animation: fadeIn 0.3s ease-in;
}

.message.user .message-content {
    background: var(--primary-color);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 1rem 1rem 0.25rem 1rem;
    max-width: 80%;
    margin-left: auto;
}

.message.bot .message-content {
    background: white;
    border: 1px solid #dee2e6;
    color: var(--dark-color);
    padding: 0.75rem 1rem;
    border-radius: 1rem 1rem 1rem 0.25rem;
    max-width: 80%;
}

.chat-input {
    border-top: 1px solid #dee2e6;
    padding: 1rem;
    background: white;
}

.bot-avatar, .user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    flex-shrink: 0;
}

.typing-indicator {
    opacity: 0.7;
}

.typing-indicator .fa-ellipsis-h {
    animation: typing 1.5s infinite;
}

@keyframes typing {
    0%, 20% { opacity: 0.3; }
    50% { opacity: 1; }
    80%, 100% { opacity: 0.3; }
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.suggestions-container {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Custom scrollbar for chat */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #0056b3;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .chat-messages {
        height: 400px;
    }
    
    .message.user .message-content,
    .message.bot .message-content {
        max-width: 90%;
    }
}
</style>
{% endblock %} 